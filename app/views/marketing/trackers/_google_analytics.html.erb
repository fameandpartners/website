<% if tracker = Spree::Tracker.current %>
  <%= javascript_tag do %>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '<%= tracker.analytics_id %>', 'auto', {'allowLinker': true});

    // enable Display Advertising Features
    ga('require', 'displayfeatures');

    // enable multi domain tracking
    // docs: https://support.google.com/analytics/answer/1034342?hl=en#GA
    ga('require', 'linker');
    ga('linker:autoLink', [
        'fameandpartners.com',
        'fameandpartners.com.au'
    ]);

    ga('send', 'pageview');

    <% if flash[:signed_up_just_now] %>
        var dataLayer = window.dataLayer || [];
        dataLayer.push({event: "registrationCompleted"});
    <% end %>

    <% if flash[:track_fb_reminder_promo] %>
      ga('send', 'event', 'Facebook', 'Redeem');
    <% end %>

    <% if flash[:track_fb_signin] %>
      ga('send', 'event', 'Facebook', 'SignIn');
    <% end %>

    <% if flash[:track_fb_signup] %>
      ga('send', 'event', 'Facebook', 'SignUp');
    <% end %>

    <% if flash[:commerce_tracking] || params[:force_tracking] && @spree_order.present? %>
      <%# more info: https://developers.google.com/analytics/devguides/collection/gajs/methods/gaJSApiEcommerce %>
      <%# _addTrans(transactionId, affiliation, total, tax, shipping, city, state, country) %>
      _gaq.push(['_addTrans',
        "<%= j @spree_order.number %>",
        "Fame & Partners",
        "<%= @spree_order.total %>",
        "<%= @spree_order.adjustments.tax.sum(:amount) %>",
        "<%= @spree_order.adjustments.shipping.sum(:amount) %>",
        "<%= j @spree_order.bill_address.city %>",
        "<%= j @spree_order.bill_address.state_text %>",
        "<%= j @spree_order.bill_address.country.name %>"
      ]);
      <% @spree_order.line_items.each do |line_item| %>
        <%
          # _addItem(transactionId, sku, name, category, price, quantity)
          range_taxon   = range_taxon_for(line_item.variant.product)
          category_name = range_taxon.present? ? range_taxon.name : ''
          sku           = CustomItemSku.new(line_item).call
        %>
        _gaq.push(['_addItem',
          "<%= j @spree_order.number %>",
          "<%= j sku %>",
          "<%= j line_item.variant.product.name %>",
          "<%= j category_name %>",
          "<%= line_item.price %>",
          "<%= line_item.quantity %>"
        ]);

      <% end %>

      <%# More details at https://developers.google.com/analytics/devguides/collection/gajs/gaTrackingEcommerce#localcurrencies %>
      _gaq.push(['_set', 'currencyCode', '<%= @spree_order.currency %>']);
      _gaq.push(['_trackTrans']);

    <% end %>
  <% end %>
<% end %>

<%# Google Shopping verification code %>
<% content_for :head do %>
  <meta name="google-site-verification" content="ASqjutBTF0pN4o6WbzPc3jV09WW2hkokCPqmVHWp1uo" />
  <meta name="msvalidate.01" content="CBAB38EE3DA1B1ED6FBC59A3C8D78614" />
  <meta name="msvalidate.01" content="704CD87A95276DC777B970ADF16EEB30" />
<% end %>

<%# fb tracking pixel %>
<% if flash[:commerce_tracking] || params[:force_tracking] %>
  <% if @spree_order.present? %>
    <%= render :partial => 'spree/shared/rakuten' %>
    <%= render :partial => 'spree/shared/polyvore' %>
    <%= render :partial => 'spree/shared/customerio' %>
  <% end %>
<% end %>
