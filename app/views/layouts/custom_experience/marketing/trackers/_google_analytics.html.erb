<% if tracker = Spree::Tracker.current %>
  <%= javascript_tag do %>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '<%= tracker.analytics_id %>', 'auto', {'allowLinker': true});

    // Optimizely Universal Analytics Integration Code
    window.optimizely = window.optimizely || [];
    window.optimizely.push( "activateUniversalAnalytics");

    // enable Display Advertising Features
    ga('require', 'displayfeatures');

    // enable multi domain tracking
    // docs: https://support.google.com/analytics/answer/1034342?hl=en#GA
    ga('require', 'linker');
    ga('linker:autoLink', ['fameandpartners.com','fameandpartners.com.au']);

    // enable ecommerce plugin
    // Notice that we NEED to remove this plugin when working with enhanced ecommerce: https://developers.google.com/analytics/devguides/collection/analyticsjs/ecommerce#overview
    ga('require', 'ecommerce');

    ga('send', 'pageview');

    <% if flash[:signed_up_just_now] %>
        var dataLayer = window.dataLayer || [];
        dataLayer.push({event: "registrationCompleted"});
    <% end %>

    <% if flash[:track_fb_reminder_promo] %>
      ga('send', 'event', 'Facebook', 'Redeem');
    <% end %>

    <% if flash[:track_fb_signin] %>
      ga('send', 'event', 'Facebook', 'SignIn');
    <% end %>

    <% if flash[:track_fb_signup] %>
      ga('send', 'event', 'Facebook', 'SignUp');
    <% end %>

    <% if flash[:commerce_tracking] || params[:force_tracking] && @spree_order.present? %>
      <%# more info: https://developers.google.com/analytics/devguides/collection/analyticsjs/ecommerce %>
      ga('ecommerce:addTransaction', {
        'id': '<%= j @spree_order.number %>',
        'affiliation': 'Fame & Partners',
        'currency': '<%= @spree_order.currency %>',
        'revenue': '<%= @spree_order.total %>',
        'shipping': '<%= @spree_order.adjustments.shipping.sum(:amount) %>',
        'tax': '<%= @spree_order.adjustments.tax.sum(:amount) %>'
      });

      <% @spree_order.line_items.each do |line_item| %>
        <%
          # _addItem(transactionId, sku, name, category, price, quantity)
          range_taxon   = range_taxon_for(line_item.variant.product)
          category_name = range_taxon.present? ? range_taxon.name : ''
          sku           = CustomItemSku.new(line_item).call
        %>

        ga('ecommerce:addItem', {
          'id': '<%= j @spree_order.number %>',
          'name': '<%= j line_item.variant.product.name %>',
          'sku': '<%= j sku %>',
          'category': '<%= j category_name %>',
          'price': '<%= line_item.price %>',
          'quantity': '<%= line_item.quantity %>'
        });
      <% end %>

      ga('ecommerce:send'); // Send transaction and item data to Google Analytics.
    <% end %>
  <% end %>
<% end %>

<%# Google Shopping verification code %>
<% content_for :head do %>
  <meta name="google-site-verification" content="ASqjutBTF0pN4o6WbzPc3jV09WW2hkokCPqmVHWp1uo" />
  <meta name="google-site-verification" content="j2cSSdzGd0URLwb0C4i2aOGD5MBbD1249e2mV3OV3OY" />
  <meta name="msvalidate.01" content="CBAB38EE3DA1B1ED6FBC59A3C8D78614" />
  <meta name="msvalidate.01" content="704CD87A95276DC777B970ADF16EEB30" />
<% end %>

<%# fb tracking pixel %>
<% if flash[:commerce_tracking] || params[:force_tracking] %>
  <% if @spree_order.present? %>
    <%= render :partial => 'spree/shared/rakuten' %>
    <%= render :partial => 'spree/shared/polyvore' %>
    <%= render :partial => 'spree/shared/customerio' %>
  <% end %>
<% end %>
