dependencies:
  pre:
    # PhantomJS 2.1.1 is available by default on CircleCI Ubuntu 14.04, https://circleci.com/docs/build-image-trusty/#phantomjs
    # Elasticsearch 1.7.2 is available by default on CircleCI Ubuntu 14.04, https://circleci.com/docs/build-image-trusty/#elasticsearch
    # git-lfs 1.5.4 is available by default on CircleCI Ubuntu 14.04, https://circleci.com/docs/build-image-trusty/#dpkg--l
    # git-lfs
    - sudo apt-get install git-lfs=1.5.4
    - ssh git@github.com git-lfs-authenticate fameandpartners/website.git download
    - git lfs pull
    # npm and bundle JS
    - npm install -g yarn
    - yarn install
    - yarn run prod
    # Bundler is missing for non-pre-installed Ruby versions https://discuss.circleci.com/t/trusty-container-update-16-02-01/1914/6
    - gem install bundler
  override:
    - bundle install:
      timeout: 180


machine:
  ruby:
    version: 2.3.3
  node:
    version: 6.1.0
  services:
    - elasticsearch
    - redis
    - memcached

general:
  artifacts:
    - "tmp/capybara"
  branches:
    ignore:
      - staging

test:
  override:
    - echo 'yicky yacky'
    # - case $CIRCLE_NODE_INDEX in 0) bundle exec rspec spec --tag $RSPEC_EXCLUDE_FLAGS -r rspec_junit_formatter --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml ;; 1) bundle exec rspec engines --tag $RSPEC_EXCLUDE_FLAGS -r rspec_junit_formatter --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml ;; esac:
    #     parallel: true

deployment:
  development:
    branch: elb-deploy
    commands:
      - cp config/database.yml.deploy config/database.yml
      - zip -r -q deploy.zip . -x \*node_modules\* -x \*.git\* -x \*doc\* -x \*rspec\*
      - aws s3 cp deploy.zip s3://dev-fameandpartners-website/deploy/deployebs.zip
      - aws elasticbeanstalk create-application-version --application-name fameosity --version-label $CIRCLE_BUILD_NUM --source-bundle S3Bucket=dev-fameandpartners-website,S3Key=deploy/deployebs.zip --region us-east-1
      - aws elasticbeanstalk update-environment --environment-name devo2 --version-label $CIRCLE_BUILD_NUM --region us-east-1
  development2:
    branch: elb-deploy2
    commands:
      - zip -r -q deploy.zip . -x \*node_modules\* -x \*.git\* -x \*doc\* -x \*rspec\*
      - aws s3 cp deploy.zip s3://dev-fameandpartners-website/deploy/deployebs.zip
      - aws elasticbeanstalk create-application-version --application-name fameosity --version-label $CIRCLE_BUILD_NUM --source-bundle S3Bucket=dev-fameandpartners-website,S3Key=deploy/deployebs.zip --region us-east-1
      - aws elasticbeanstalk update-environment --environment-name development2 --version-label $CIRCLE_BUILD_NUM --region us-east-1
